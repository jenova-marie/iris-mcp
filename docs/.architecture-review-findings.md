# ARCHITECTURE.md Review Findings
**Date:** 2025-10-18
**Reviewer:** Claude Code (Sassy Tech Writer Mode)
**Document Reviewed:** docs/ARCHITECTURE.md v2.1

## Executive Summary

ARCHITECTURE.md is **significantly out of date** with the actual implementation. Multiple major features marked as "future" or "under construction" are actually **fully implemented and production-ready**. The document needs substantial updates to reflect the current state of the system.

---

## Critical Discrepancies

### 1. MCP Tool Count & Names

**Documented:** 17 tools listed in tool registration diagram (lines 131-138)
**Actual:** 17 tools registered in src/mcp_server.ts

‚úÖ **Tool count is CORRECT**

‚ùå **Tool names partially incorrect:**
- Document lists `team_cache_read` and `team_cache_clear` in the diagram
- **These tools do NOT exist in the codebase** (no files in src/actions/)
- Verified: Only 16 action files exist (15 actual actions + 1 index.ts)

**Actual tools registered (from grep of mcp_server.ts):**
1. send_message
2. quick_message
3. ask_message
4. session_reboot
5. session_delete
6. session_fork
7. team_status
8. team_wake
9. team_launch
10. team_sleep
11. team_wake_all
12. session_report
13. session_cancel
14. list_teams
15. get_logs
16. permissions__approve
17. get_date

**Missing from diagram:** ask_message, team_launch (semantic aliases)
**Incorrectly listed:** team_cache_read, team_cache_clear (don't exist)

---

### 2. Phase 2: Dashboard (MAJOR FINDING)

**Documented (lines 629-641):**
```
### Phase 2: React Dashboard üöß
**Location:** `src/dashboard/`
**Tech Stack:** React 18 + Express + Socket.io
**Purpose:** Web UI for monitoring teams, processes, cache

**Status:** Future phase, not implemented
```

**ACTUAL STATUS:** ‚úÖ **FULLY IMPLEMENTED AND PRODUCTION-READY**

**Evidence:**
- `src/dashboard/` directory exists with complete implementation
- **Server-side:**
  - `src/dashboard/server/index.ts` - Express server with WebSocket
  - `src/dashboard/server/state-bridge.ts` - State synchronization
  - `src/dashboard/server/routes/processes.ts` - Process management API
  - `src/dashboard/server/routes/config.ts` - Config management API

- **Client-side (React SPA):**
  - `src/dashboard/client/src/App.tsx` - Main application
  - `src/dashboard/client/src/pages/ProcessMonitor.tsx` - Process monitoring
  - `src/dashboard/client/src/pages/LogViewer.tsx` - Real-time log viewing
  - `src/dashboard/client/src/pages/ConfigEditor.tsx` - Configuration editor
  - `src/dashboard/client/src/components/PermissionApprovalModal.tsx` - Permission UI
  - `src/dashboard/client/src/hooks/useWebSocket.ts` - WebSocket integration
  - Vite build configuration

**Features Actually Implemented:**
- ‚úÖ Real-time process status monitoring
- ‚úÖ Cache inspection
- ‚úÖ Session history
- ‚úÖ Manual process control
- ‚úÖ Permission approval UI with modal dialogs
- ‚úÖ Real-time log streaming
- ‚úÖ Configuration editor
- ‚úÖ WebSocket live updates

**This is a HUGE discrepancy!** The document says it's future work, but it's actually complete!

---

### 3. Phase 3: HTTP/WebSocket API

**Documented (lines 643-652):**
```
### Phase 3: HTTP/WebSocket API üöß
**Location:** `src/api/`
**Status:** Future phase, not implemented
```

**ACTUAL STATUS:** ‚ö†Ô∏è **PARTIALLY IMPLEMENTED**

**Evidence:**
- `src/api/` directory exists but only contains README.md
- **However:** HTTP/WebSocket API is actually implemented in `src/mcp_server.ts`!

**What's Actually Implemented:**
- MCP Server supports BOTH stdio and HTTP transports (line 882-884)
- HTTP endpoints exist:
  - `/mcp` - General MCP HTTP endpoint
  - `/mcp/:sessionId` - Session-specific endpoint for reverse MCP
- Express app with JSON middleware
- StreamableHTTPServerTransport for HTTP communication
- Session-based request routing

**Discrepancy:** The API isn't in a separate `src/api/` module, but HTTP/WebSocket functionality IS implemented within the MCP server itself to support the Dashboard and Reverse MCP features.

---

### 4. Phase 4: CLI Interface

**Documented (lines 654-665):**
```
### Phase 4: CLI Interface üöß
**Location:** `src/cli/`
**Tech Stack:** Ink 5 (React for terminals) + Commander
**Status:** Future phase, not implemented
```

**ACTUAL STATUS:** ‚ö†Ô∏è **PARTIALLY IMPLEMENTED (but NOT using Ink)**

**Evidence:**
- `src/cli/` directory exists
- `src/cli/commands/` contains:
  - `install.ts` - Installation command
  - `uninstall.ts` - Uninstallation command
  - `add-team.ts` - Add team to config
- `src/cli/index.ts` - Exports commands

**Discrepancy:** CLI exists but does NOT use Ink (React for terminals) as documented. These are plain TypeScript command implementations, not React-based terminal UI.

---

### 5. Transport Abstraction Layer (NOT DOCUMENTED)

**Documented:** ARCHITECTURE.md shows ClaudeProcess as directly spawning processes (diagram lines 169-175)

**ACTUAL:** ‚ùå **MAJOR ARCHITECTURAL COMPONENT MISSING FROM DOCUMENTATION**

**Evidence:**
- `src/transport/` directory with complete transport abstraction:
  - `transport.interface.ts` - Transport interface definition
  - `local-transport.ts` - Local process execution
  - `ssh-transport.ts` - Remote SSH execution
  - `transport-factory.ts` - Factory pattern for transport selection

**Actual Architecture:**
```
ClaudeProcess
  ‚îî‚îÄ‚îÄ Transport (abstraction)
      ‚îú‚îÄ‚îÄ LocalTransport (local execution)
      ‚îî‚îÄ‚îÄ SSHTransport (remote execution via OpenSSH)
```

**Key Features:**
- RxJS reactive streams (status$, errors$)
- CommandInfo pre-built commands
- Debug methods (getLaunchCommand, getTeamConfigSnapshot)
- Cancel operation support
- Metrics reporting

**ClaudeProcess Actual Implementation:**
- Line 71: `private transport: Transport;`
- Uses TransportFactory.create() to instantiate correct transport
- Delegates spawn() and executeTell() to transport
- Does NOT directly spawn child processes

This is a **fundamental architectural change** not reflected in the documentation!

---

### 6. Database Schema

**Documented (lines 170-176):**
```
‚îÇ team-sessions.db     ‚îÇ
‚îÇ from_team            ‚îÇ
‚îÇ to_team              ‚îÇ
‚îÇ session_id           ‚îÇ
‚îÇ process_state        ‚îÇ
‚îÇ last_response_at     ‚îÇ
```

**ACTUAL (from session-store.ts lines 96-111):**
```sql
CREATE TABLE IF NOT EXISTS team_sessions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  from_team TEXT NOT NULL,
  to_team TEXT NOT NULL,
  session_id TEXT NOT NULL UNIQUE,
  created_at INTEGER NOT NULL,
  last_used_at INTEGER NOT NULL,
  message_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'active',
  process_state TEXT NOT NULL DEFAULT 'stopped',
  current_cache_session_id TEXT,
  last_response_at INTEGER,
  launch_command TEXT,           -- NEW, not documented
  team_config_snapshot TEXT,     -- NEW, not documented
  UNIQUE(from_team, to_team)
);
```

**Missing from documentation:**
- `id` - Primary key
- `created_at` - Creation timestamp
- `last_used_at` - Last usage timestamp
- `message_count` - Total messages processed
- `status` - Session status ('active')
- `current_cache_session_id` - Active cache session
- `launch_command` - Debug info
- `team_config_snapshot` - Debug info

---

### 7. Missing Features Not Documented

The following **implemented features** are not mentioned in ARCHITECTURE.md:

#### A. Reverse MCP Tunneling
- SSH reverse tunnels for remote ‚Üí local communication
- `/mcp/:sessionId` session-specific endpoints
- Permission approval system for remote tools
- Bidirectional team coordination

**Files:**
- Implemented throughout transport layer
- Session-specific routing in mcp_server.ts (lines 950-977)

#### B. Session MCP Configuration
- Automatic MCP config file generation
- Bidirectional Claude communication
- MCP config scripts (mcp-cp.sh, mcp-scp.sh)
- Session-specific config deployment

**Configuration:**
- `sessionMcpEnabled`
- `sessionMcpPath`
- `mcpConfigScript`

#### C. Permission Approval System
- `PendingPermissionsManager` - Manages "ask" mode permissions
- Dashboard integration for manual approval
- WebSocket events: `permission:request`, `permission:resolved`, `permission:timeout`
- Permission modes: yes/no/ask/forward

**Files:**
- `src/permissions/pending-manager.ts`
- Dashboard modal: `src/dashboard/client/src/components/PermissionApprovalModal.tsx`

#### D. RxJS Reactive Observables
- Transport status streams (`status$`, `errors$`)
- Process status observables
- Real-time event propagation

**Evidence:**
- ClaudeProcess line 80: `private statusSubject = new BehaviorSubject<ProcessStatus>`
- Transport interface defines `status$` and `errors$` observables

#### E. Debug Tooling
- `getLaunchCommand()` - Get process launch command
- `getTeamConfigSnapshot()` - Get team configuration
- `cancel()` - Send ESC to stdin to cancel operation

**Integration:**
- Stored in database (`launch_command`, `team_config_snapshot`)
- Accessible via dashboard
- Added to session records

---

## Recommendations for ARCHITECTURE.md Updates

### 1. Update Phase Status Sections

**Change:**
```diff
-### Phase 2: React Dashboard üöß
-**Status:** Future phase, not implemented
+### Phase 2: React Dashboard ‚úÖ IMPLEMENTED
+**Status:** Production-ready, fully functional
```

Add detailed feature list of what's actually implemented.

**Change:**
```diff
-### Phase 3: HTTP/WebSocket API üöß
-**Status:** Future phase, not implemented
+### Phase 3: HTTP/WebSocket API ‚úÖ PARTIALLY IMPLEMENTED
+**Status:** HTTP transport implemented in MCP server
+**Note:** Separate REST API module (src/api/) is planned but HTTP/WS functionality exists
```

**Change:**
```diff
-### Phase 4: CLI Interface üöß
-**Tech Stack:** Ink 5 (React for terminals) + Commander
-**Status:** Future phase, not implemented
+### Phase 4: CLI Interface ‚ö†Ô∏è PARTIALLY IMPLEMENTED
+**Tech Stack:** Plain TypeScript commands (Ink integration pending)
+**Status:** Install/uninstall/add-team commands working
+**Note:** Ink-based terminal UI is still planned
```

### 2. Add Transport Abstraction Section

Insert new section after "Component Hierarchy" (around line 217):

```markdown
## Transport Layer Architecture

**Critical:** ClaudeProcess does NOT directly spawn processes. It delegates to a Transport abstraction layer.

### Transport Interface

```typescript
interface Transport {
  status$: Observable<TransportStatus>;  // RxJS reactive stream
  errors$: Observable<Error>;

  spawn(spawnCacheEntry, commandInfo, timeout): Promise<void>;
  executeTell(cacheEntry): void;
  terminate(): Promise<void>;
  isReady(): boolean;
  isBusy(): boolean;
  getMetrics(): TransportMetrics;
  getPid(): number | null;
  cancel?(): void;
  getLaunchCommand?(): string | null;
  getTeamConfigSnapshot?(): string | null;
}
```

### Implementations

1. **LocalTransport** - Spawns child processes locally via `child_process.spawn()`
2. **SSHTransport** - Executes remotely via OpenSSH client (`ssh` command)
3. **TransportFactory** - Selects transport based on `remote` config field

### Architecture Diagram

```
Iris Orchestrator
    ‚Üì
ClaudeProcess (wrapper)
    ‚Üì
Transport (abstraction)
    ‚Üì
    ‚îú‚îÄ‚îÄ LocalTransport ‚Üí child_process.spawn()
    ‚îî‚îÄ‚îÄ SSHTransport ‚Üí ssh command
```
```

### 3. Update Tool Registration Diagram

**Remove:**
- `team_cache_read`
- `team_cache_clear`

**Add:**
- `ask_message` (semantic alias)
- `team_launch` (semantic alias)

### 4. Update Database Schema Diagram

Add all missing fields to the team_sessions table visualization (lines 170-176).

### 5. Add New Sections

#### "Permission Approval System"
- Document PendingPermissionsManager
- Permission modes (yes/no/ask/forward)
- Dashboard integration
- WebSocket event flow

#### "Reverse MCP & Session MCP"
- Reverse tunneling architecture
- Session-specific MCP config generation
- Bidirectional team communication
- MCP config scripts

#### "Debug & Observability"
- Debug methods in Transport
- Launch command tracking
- Team config snapshots
- Session metadata storage

### 6. Update Version and Last Modified

```diff
-**Document Version:** 2.1
-**Last Updated:** October 2025
+**Document Version:** 3.0
+**Last Updated:** October 18, 2025
```

Add change log explaining major updates.

---

## Priority Ranking

1. **Critical:** Update Phase 2 status (Dashboard is fully implemented)
2. **Critical:** Add Transport Abstraction section (fundamental architecture change)
3. **High:** Fix tool registration (remove non-existent cache tools)
4. **High:** Add Permission Approval System section
5. **High:** Add Reverse MCP & Session MCP section
6. **Medium:** Update database schema diagram
7. **Medium:** Update Phase 3 & 4 status
8. **Low:** Add debug tooling documentation

---

## Files Reviewed

- `src/mcp_server.ts` - MCP tool registration, HTTP/stdio transport
- `src/actions/*.ts` - All action implementations
- `src/dashboard/` - Complete dashboard implementation
- `src/transport/` - Transport abstraction layer
- `src/process-pool/claude-process.ts` - Process wrapper
- `src/session/session-store.ts` - Database schema
- `src/permissions/pending-manager.ts` - Permission system
- `src/cli/` - CLI commands

---

## Conclusion

ARCHITECTURE.md requires a **major update** to reflect the actual state of the system. Multiple significant features are production-ready but documented as "future work," and fundamental architectural patterns (Transport abstraction) are completely missing from the documentation.

**Estimated update effort:** 2-3 hours for comprehensive revision.

**Recommendation:** Perform complete rewrite of sections 3-7 to ensure accuracy.
